generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// MULTI-TENANT ORGANIZATION MODELS
// ===========================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  domain      String?  @unique // Custom domain support
  subdomain   String?  @unique // firm.lawplatform.com
  logo        String?
  favicon     String?
  description String?
  website     String?
  phone       String?
  email       String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String   @default("US")
  timezone    String   @default("America/New_York")

  // Subscription & Billing
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?
  plan                 PlanType  @default(TRIAL)
  planExpiresAt        DateTime?
  trialEndsAt          DateTime?

  // Settings
  settings     OrganizationSettings?
  branding     OrganizationBranding?

  // Relations
  users        OrganizationUser[]
  clients      Client[]
  cases        Case[]
  invitations  Invitation[]
  landingPages LandingPage[]
  documents    Document[]
  intakeForms  IntakeForm[]
  workflows    Workflow[]
  templates    Template[]
  invoices     Invoice[]
  appointments Appointment[]
  messages     Message[]
  auditLogs    AuditLog[]
  aiJobs       AIJob[]
  integrations Integration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([domain])
  @@index([subdomain])
}

model OrganizationSettings {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Security Settings
  require2FA           Boolean @default(true)
  sessionTimeout       Int     @default(480) // minutes
  maxLoginAttempts     Int     @default(5)
  passwordMinLength    Int     @default(12)
  requirePasswordReset Boolean @default(false)
  ipWhitelist          String[] // JSON array of allowed IPs

  // Notification Settings
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)
  pushNotifications  Boolean @default(true)

  // Feature Toggles
  enableVideoConsultations Boolean @default(true)
  enableOnlinePayments     Boolean @default(true)
  enableDocumentSigning    Boolean @default(true)
  enableClientMessaging    Boolean @default(true)
  enableAIFeatures         Boolean @default(true)

  // Billing Settings
  defaultHourlyRate   Decimal?  @db.Decimal(10, 2)
  defaultCurrency     String    @default("USD")
  paymentTermsDays    Int       @default(30)
  autoSendInvoices    Boolean   @default(false)
  acceptedPaymentMethods String[] // ['card', 'ach', 'check']

  // Compliance
  dataRetentionDays    Int      @default(2555) // ~7 years
  enableAuditLogging   Boolean  @default(true)
  hipaaCompliant       Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationBranding {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Colors
  primaryColor    String @default("#1a365d")
  secondaryColor  String @default("#d69e2e")
  accentColor     String @default("#2d3748")
  backgroundColor String @default("#ffffff")
  textColor       String @default("#1a202c")

  // Typography
  headingFont String @default("Playfair Display")
  bodyFont    String @default("Inter")

  // Custom CSS
  customCss String? @db.Text

  // Email Templates
  emailHeaderHtml String? @db.Text
  emailFooterHtml String? @db.Text
  emailSignature  String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===========================================
// USER & AUTHENTICATION MODELS
// ===========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?   // Hashed password

  // Profile
  firstName     String?
  lastName      String?
  phone         String?
  avatar        String?
  title         String?   // Attorney, Paralegal, etc.
  bio           String?   @db.Text
  barNumber     String?   // For attorneys
  practiceAreas String[]  // Areas of practice

  // 2FA
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  twoFactorBackupCodes String[] // Encrypted backup codes

  // Security
  lastLoginAt      DateTime?
  lastLoginIp      String?
  failedLoginAttempts Int     @default(0)
  lockedUntil      DateTime?
  passwordChangedAt DateTime?
  mustChangePassword Boolean @default(false)

  // Status
  status        UserStatus @default(ACTIVE)

  // Relations
  organizations OrganizationUser[]
  sessions      Session[]
  accounts      Account[]
  devices       UserDevice[]

  // Activity (as actor)
  sentMessages     Message[]      @relation("SentMessages")
  assignedCases    CaseAssignment[]
  assignedTasks    Task[]         @relation("AssignedTasks")
  createdTasks     Task[]         @relation("CreatedTasks")
  appointments     Appointment[]  @relation("AttorneyAppointments")
  auditLogs        AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model OrganizationUser {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  role           UserRole     @default(STAFF)
  permissions    String[]     // Granular permissions

  // Attorney-specific
  hourlyRate     Decimal?     @db.Decimal(10, 2)

  // Landing page slug (for attorneys)
  profileSlug    String?
  landingPageId  String?
  landingPage    LandingPage? @relation(fields: [landingPageId], references: [id])

  isActive       Boolean      @default(true)
  joinedAt       DateTime     @default(now())

  @@unique([organizationId, userId])
  @@unique([organizationId, profileSlug])
  @@index([organizationId])
  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session tracking
  ipAddress    String?
  userAgent    String?
  deviceType   String?
  location     String?

  createdAt    DateTime @default(now())

  @@index([userId])
}

model UserDevice {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceId    String   @unique
  deviceName  String?
  deviceType  String?  // mobile, desktop, tablet
  browser     String?
  os          String?

  isTrusted   Boolean  @default(false)
  lastUsedAt  DateTime @default(now())

  createdAt   DateTime @default(now())

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  type       TokenType @default(EMAIL_VERIFICATION)

  @@unique([identifier, token])
}

// ===========================================
// CLIENT MODELS
// ===========================================

model Client {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Authentication (for client portal)
  email          String
  password       String?      // Hashed password for portal access
  emailVerified  DateTime?

  // Profile
  firstName      String
  lastName       String
  middleName     String?
  phone          String?
  alternatePhone String?
  dateOfBirth    DateTime?
  ssn            String?      // Encrypted

  // Address
  address        String?
  address2       String?
  city           String?
  state          String?
  zipCode        String?
  country        String       @default("US")

  // Emergency Contact
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelation String?

  // Client Settings
  preferredContactMethod ContactMethod @default(EMAIL)
  language               String        @default("en")
  timezone               String?

  // Portal 2FA
  twoFactorEnabled     Boolean  @default(false)
  twoFactorSecret      String?

  // Status
  status         ClientStatus @default(PROSPECT)
  source         String?      // How they found the firm
  referredBy     String?      // Referral source

  // AI Analysis
  sentimentScore    Float?    // 0-1 scale
  riskScore         Float?    // 0-1 scale
  engagementScore   Float?    // 0-1 scale
  predictedValue    Decimal?  @db.Decimal(10, 2)

  // Relations
  cases          Case[]
  documents      Document[]
  messages       Message[]    @relation("ClientMessages")
  appointments   Appointment[]
  invoices       Invoice[]
  payments       Payment[]
  intakeResponses IntakeResponse[]
  portalSessions ClientPortalSession[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([status])
}

model ClientPortalSession {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  token       String   @unique
  expiresAt   DateTime
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  @@index([clientId])
  @@index([token])
}

// ===========================================
// INVITATION SYSTEM
// ===========================================

model Invitation {
  id             String           @id @default(cuid())
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Invitation Details
  email          String
  phone          String?
  firstName      String?
  lastName       String?

  // Token
  token          String           @unique
  expiresAt      DateTime

  // Type & Status
  type           InvitationType   @default(CLIENT)
  status         InvitationStatus @default(PENDING)

  // Tracking
  sentAt         DateTime?
  sentVia        String[]         // ['email', 'sms']
  openedAt       DateTime?
  clickedAt      DateTime?
  completedAt    DateTime?

  // Referral to specific attorney/page
  landingPageId  String?
  landingPage    LandingPage?     @relation(fields: [landingPageId], references: [id])

  // Associated intake form
  intakeFormId   String?
  intakeForm     IntakeForm?      @relation(fields: [intakeFormId], references: [id])

  // For case/matter pre-assignment
  caseId         String?
  case           Case?            @relation(fields: [caseId], references: [id])

  // QR Code
  qrCodeUrl      String?

  // Notes
  message        String?          @db.Text
  internalNotes  String?          @db.Text

  // Metadata
  metadata       Json?

  createdById    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([organizationId])
  @@index([token])
  @@index([email])
  @@index([status])
}

// ===========================================
// LANDING PAGE SYSTEM
// ===========================================

model LandingPage {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // URL
  slug           String
  customDomain   String?

  // Page Details
  title          String
  subtitle       String?
  description    String?      @db.Text
  metaTitle      String?
  metaDescription String?     @db.Text

  // Template
  template       LandingPageTemplate @default(PROFESSIONAL)

  // Content (JSON structure)
  heroSection    Json?
  aboutSection   Json?
  servicesSection Json?
  testimonialsSection Json?
  ctaSection     Json?
  contactSection Json?
  customSections Json?

  // Media
  heroImage      String?
  backgroundImage String?
  galleryImages  String[]

  // Features
  showContactForm  Boolean    @default(true)
  showBookingWidget Boolean   @default(true)
  showTestimonials Boolean    @default(true)
  showPracticeAreas Boolean   @default(true)

  // Associated Forms
  intakeFormId   String?
  intakeForm     IntakeForm?  @relation(fields: [intakeFormId], references: [id])

  // Analytics
  views          Int          @default(0)
  uniqueVisitors Int          @default(0)
  conversions    Int          @default(0)

  // Status
  status         PageStatus   @default(DRAFT)
  publishedAt    DateTime?

  // Relations
  attorneys      OrganizationUser[]
  invitations    Invitation[]
  pageViews      PageView[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([slug])
  @@index([customDomain])
}

model PageView {
  id            String      @id @default(cuid())
  landingPageId String
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  // Visitor Info
  visitorId     String?     // Anonymous visitor tracking
  ipAddress     String?
  userAgent     String?
  referrer      String?

  // UTM Parameters
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?

  // Engagement
  timeOnPage    Int?        // seconds
  scrollDepth   Int?        // percentage
  converted     Boolean     @default(false)

  createdAt     DateTime    @default(now())

  @@index([landingPageId])
  @@index([createdAt])
}

// ===========================================
// CASE/MATTER MANAGEMENT
// ===========================================

model Case {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  clientId       String
  client         Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Case Details
  caseNumber     String
  title          String
  description    String?      @db.Text

  // Classification
  practiceArea   String
  caseType       String?
  subType        String?

  // Status & Timeline
  status         CaseStatus   @default(INTAKE)
  priority       CasePriority @default(NORMAL)
  stage          String?      // Custom stage within status

  openedAt       DateTime     @default(now())
  closedAt       DateTime?

  // Important Dates
  statuteOfLimitations DateTime?
  nextDeadline   DateTime?
  trialDate      DateTime?

  // Court Information
  courtName      String?
  courtCaseNumber String?
  judgeName      String?
  opposingCounsel String?
  opposingParty  String?

  // Financial
  estimatedValue Decimal?     @db.Decimal(12, 2)
  settledAmount  Decimal?     @db.Decimal(12, 2)
  feeArrangement FeeArrangement @default(HOURLY)
  contingencyPercent Decimal? @db.Decimal(5, 2)
  retainerAmount Decimal?     @db.Decimal(10, 2)

  // AI Analysis
  winProbability Float?       // 0-1 scale
  riskScore      Float?       // 0-1 scale
  complexityScore Float?      // 0-1 scale
  aiSummary      String?      @db.Text
  aiRecommendations Json?

  // Relations
  assignments    CaseAssignment[]
  documents      Document[]
  tasks          Task[]
  timeEntries    TimeEntry[]
  invoices       Invoice[]
  appointments   Appointment[]
  messages       Message[]
  events         CaseEvent[]
  invitations    Invitation[]
  notes          CaseNote[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, caseNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([practiceArea])
}

model CaseAssignment {
  id        String   @id @default(cuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role      String   @default("Attorney") // Lead Attorney, Paralegal, etc.
  isPrimary Boolean  @default(false)

  assignedAt DateTime @default(now())

  @@unique([caseId, userId])
  @@index([caseId])
  @@index([userId])
}

model CaseEvent {
  id          String    @id @default(cuid())
  caseId      String
  case        Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)

  title       String
  description String?   @db.Text
  eventType   String    // filing, hearing, deadline, milestone, etc.
  eventDate   DateTime

  // AI Generated
  isAiGenerated Boolean @default(false)
  sourceDocumentId String?

  // Status
  isCompleted Boolean   @default(false)
  completedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([caseId])
  @@index([eventDate])
}

model CaseNote {
  id          String   @id @default(cuid())
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  content     String   @db.Text
  isPrivate   Boolean  @default(false) // Not visible to client
  isPinned    Boolean  @default(false)

  // AI Generated
  isAiGenerated Boolean @default(false)
  aiSource    String?  // meeting_summary, document_analysis, etc.

  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([caseId])
}

// ===========================================
// DOCUMENT MANAGEMENT
// ===========================================

model Document {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // File Info
  name           String
  originalName   String
  mimeType       String
  size           Int          // bytes

  // Storage
  storageKey     String       // S3 key or file path
  storageUrl     String?
  thumbnailUrl   String?

  // Classification
  category       DocumentCategory @default(OTHER)
  tags           String[]

  // Associations
  clientId       String?
  client         Client?      @relation(fields: [clientId], references: [id])
  caseId         String?
  case           Case?        @relation(fields: [caseId], references: [id])

  // Version Control
  version        Int          @default(1)
  parentId       String?      // For versioning

  // Security
  isConfidential Boolean      @default(false)
  accessLevel    AccessLevel  @default(INTERNAL)

  // AI Analysis
  isAnalyzed     Boolean      @default(false)
  aiSummary      String?      @db.Text
  aiKeyTerms     Json?        // Extracted terms, dates, parties
  aiRiskFlags    Json?        // Identified risks/issues
  textContent    String?      @db.Text // Extracted text for search

  // E-Signature
  signatureStatus SignatureStatus?
  signatureRequestId String?  // DocuSign envelope ID
  signedAt       DateTime?

  // Expiration Tracking
  expiresAt      DateTime?
  expirationNotified Boolean  @default(false)

  uploadedById   String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([clientId])
  @@index([caseId])
  @@index([category])
}

// ===========================================
// INTAKE FORMS
// ===========================================

model IntakeForm {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  description    String?
  practiceArea   String?

  // Form Schema (JSON)
  schema         Json         // Form fields definition
  settings       Json?        // Form settings

  // AI Generated
  isAiGenerated  Boolean      @default(false)

  // Status
  isActive       Boolean      @default(true)

  // Relations
  responses      IntakeResponse[]
  landingPages   LandingPage[]
  invitations    Invitation[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([practiceArea])
}

model IntakeResponse {
  id           String     @id @default(cuid())
  intakeFormId String
  intakeForm   IntakeForm @relation(fields: [intakeFormId], references: [id], onDelete: Cascade)
  clientId     String?
  client       Client?    @relation(fields: [clientId], references: [id])

  // Response Data
  data         Json       // Form responses

  // AI Analysis
  aiSummary    String?    @db.Text
  aiExtractedData Json?   // Structured data extracted by AI
  aiSuggestedCaseType String?

  // Status
  status       IntakeStatus @default(SUBMITTED)
  reviewedAt   DateTime?
  reviewedById String?

  // Source Tracking
  source       String?    // landing_page, direct, invitation
  sourceId     String?    // ID of landing page or invitation

  ipAddress    String?
  userAgent    String?

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([intakeFormId])
  @@index([clientId])
  @@index([status])
}

// ===========================================
// MESSAGING & COMMUNICATION
// ===========================================

model Message {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Participants
  senderId       String?
  sender         User?        @relation("SentMessages", fields: [senderId], references: [id])
  clientId       String?
  client         Client?      @relation("ClientMessages", fields: [clientId], references: [id])

  // Context
  caseId         String?
  case           Case?        @relation(fields: [caseId], references: [id])

  // Content
  content        String       @db.Text
  contentType    MessageType  @default(TEXT)

  // Attachments
  attachments    Json?        // Array of attachment objects

  // Status
  isFromClient   Boolean      @default(false)
  isRead         Boolean      @default(false)
  readAt         DateTime?

  // AI Analysis
  sentiment      String?      // positive, negative, neutral
  urgency        String?      // low, medium, high
  aiSuggestedResponse String? @db.Text

  // Threading
  threadId       String?
  parentId       String?

  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([clientId])
  @@index([caseId])
  @@index([threadId])
  @@index([createdAt])
}

// ===========================================
// APPOINTMENTS & SCHEDULING
// ===========================================

model Appointment {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Participants
  attorneyId     String
  attorney       User         @relation("AttorneyAppointments", fields: [attorneyId], references: [id])
  clientId       String
  client         Client       @relation(fields: [clientId], references: [id])
  caseId         String?
  case           Case?        @relation(fields: [caseId], references: [id])

  // Appointment Details
  title          String
  description    String?      @db.Text
  type           AppointmentType @default(CONSULTATION)

  // Timing
  startTime      DateTime
  endTime        DateTime
  timezone       String       @default("America/New_York")

  // Location
  locationType   LocationType @default(VIDEO)
  location       String?      // Physical address or video link
  videoRoomId    String?      // Daily.co room ID
  videoRoomUrl   String?

  // Status
  status         AppointmentStatus @default(SCHEDULED)

  // Reminders
  remindersSent  String[]     // Array of reminder types sent

  // AI Features
  transcription  String?      @db.Text
  aiSummary      String?      @db.Text
  aiActionItems  Json?        // Extracted action items

  // Notes
  internalNotes  String?      @db.Text
  clientNotes    String?      @db.Text

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([attorneyId])
  @@index([clientId])
  @@index([startTime])
  @@index([status])
}

// ===========================================
// TASKS & WORKFLOWS
// ===========================================

model Task {
  id             String       @id @default(cuid())
  organizationId String

  // Task Details
  title          String
  description    String?      @db.Text

  // Assignment
  assignedToId   String?
  assignedTo     User?        @relation("AssignedTasks", fields: [assignedToId], references: [id])
  createdById    String?
  createdBy      User?        @relation("CreatedTasks", fields: [createdById], references: [id])

  // Context
  caseId         String?
  case           Case?        @relation(fields: [caseId], references: [id])

  // Status & Priority
  status         TaskStatus   @default(TODO)
  priority       TaskPriority @default(MEDIUM)

  // Timing
  dueDate        DateTime?
  completedAt    DateTime?

  // AI Features
  isAiGenerated  Boolean      @default(false)
  aiSource       String?      // meeting, document, deadline_calculator

  // Workflow
  workflowId     String?
  workflow       Workflow?    @relation(fields: [workflowId], references: [id])
  workflowStepId String?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([assignedToId])
  @@index([caseId])
  @@index([status])
  @@index([dueDate])
}

model Workflow {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  description    String?
  triggerType    WorkflowTrigger
  triggerConfig  Json?        // Trigger configuration

  // Steps (JSON array of workflow steps)
  steps          Json

  // Status
  isActive       Boolean      @default(true)

  // Stats
  timesTriggered Int          @default(0)
  lastTriggeredAt DateTime?

  // Relations
  tasks          Task[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([triggerType])
}

// ===========================================
// TIME TRACKING & BILLING
// ===========================================

model TimeEntry {
  id             String       @id @default(cuid())
  organizationId String

  // Association
  caseId         String
  case           Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  userId         String

  // Time
  date           DateTime
  duration       Int          // minutes

  // Details
  description    String       @db.Text
  activityType   String?      // Research, Drafting, Court, etc.

  // Billing
  isBillable     Boolean      @default(true)
  hourlyRate     Decimal?     @db.Decimal(10, 2)
  amount         Decimal?     @db.Decimal(10, 2)

  // Invoice Association
  invoiceId      String?
  invoice        Invoice?     @relation(fields: [invoiceId], references: [id])

  // AI Features
  isAiSuggested  Boolean      @default(false)
  aiConfidence   Float?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([caseId])
  @@index([userId])
  @@index([date])
}

model Invoice {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Client & Case
  clientId       String
  client         Client       @relation(fields: [clientId], references: [id])
  caseId         String?
  case           Case?        @relation(fields: [caseId], references: [id])

  // Invoice Details
  invoiceNumber  String

  // Amounts
  subtotal       Decimal      @db.Decimal(12, 2)
  taxRate        Decimal?     @db.Decimal(5, 2)
  taxAmount      Decimal?     @db.Decimal(12, 2)
  discountAmount Decimal?     @db.Decimal(12, 2)
  total          Decimal      @db.Decimal(12, 2)
  amountPaid     Decimal      @default(0) @db.Decimal(12, 2)
  amountDue      Decimal      @db.Decimal(12, 2)

  // Dates
  issueDate      DateTime     @default(now())
  dueDate        DateTime
  paidAt         DateTime?

  // Status
  status         InvoiceStatus @default(DRAFT)

  // Payment
  stripeInvoiceId String?
  paymentUrl     String?

  // Line Items
  lineItems      Json         // Array of line items

  // Notes
  notes          String?      @db.Text
  terms          String?      @db.Text

  // AI Features
  aiPredictedPaymentDate DateTime?
  aiPaymentRisk  String?      // low, medium, high

  // Relations
  timeEntries    TimeEntry[]
  payments       Payment[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
}

model Payment {
  id             String       @id @default(cuid())
  organizationId String

  // Association
  invoiceId      String
  invoice        Invoice      @relation(fields: [invoiceId], references: [id])
  clientId       String
  client         Client       @relation(fields: [clientId], references: [id])

  // Payment Details
  amount         Decimal      @db.Decimal(12, 2)
  method         PaymentMethod

  // Stripe
  stripePaymentId String?
  stripeChargeId  String?

  // Status
  status         PaymentStatus @default(PENDING)

  // Metadata
  description    String?
  receiptUrl     String?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([invoiceId])
  @@index([clientId])
}

// ===========================================
// TEMPLATES
// ===========================================

model Template {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  description    String?
  type           TemplateType
  category       String?      // Practice area or general category

  // Content
  subject        String?      // For emails
  content        String       @db.Text
  variables      Json?        // Available merge fields

  // AI Features
  isAiGenerated  Boolean      @default(false)
  aiPrompt       String?      @db.Text // Prompt used to generate

  isActive       Boolean      @default(true)
  isDefault      Boolean      @default(false)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([type])
}

// ===========================================
// INTEGRATIONS
// ===========================================

model Integration {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  type           IntegrationType
  name           String

  // Credentials (encrypted)
  accessToken    String?
  refreshToken   String?
  apiKey         String?
  credentials    Json?        // Additional credentials

  // Status
  isActive       Boolean      @default(true)
  lastSyncAt     DateTime?
  lastError      String?

  // Settings
  settings       Json?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, type])
  @@index([organizationId])
}

// ===========================================
// AI JOBS & PROCESSING
// ===========================================

model AIJob {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  type           AIJobType
  status         AIJobStatus  @default(PENDING)

  // Input/Output
  input          Json
  output         Json?
  error          String?

  // Model Info
  modelUsed      String?      // gpt-4, claude-3, llama, etc.
  tokensUsed     Int?
  processingTime Int?         // milliseconds

  // Association
  entityType     String?      // document, case, client, etc.
  entityId       String?

  createdAt      DateTime     @default(now())
  completedAt    DateTime?

  @@index([organizationId])
  @@index([type])
  @@index([status])
}

// ===========================================
// AUDIT LOGGING
// ===========================================

model AuditLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Actor
  userId         String?
  user           User?        @relation(fields: [userId], references: [id])
  clientId       String?

  // Action
  action         String       // create, update, delete, view, export, etc.
  entityType     String       // case, document, client, etc.
  entityId       String?

  // Details
  description    String?
  oldValue       Json?
  newValue       Json?

  // Context
  ipAddress      String?
  userAgent      String?

  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ===========================================
// ENUMS
// ===========================================

enum PlanType {
  TRIAL
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum UserRole {
  OWNER
  ADMIN
  ATTORNEY
  PARALEGAL
  STAFF
  BILLING
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR
  INVITATION
}

enum ClientStatus {
  PROSPECT
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ContactMethod {
  EMAIL
  PHONE
  SMS
  PORTAL
}

enum InvitationType {
  CLIENT
  TEAM_MEMBER
  REFERRAL
}

enum InvitationStatus {
  PENDING
  SENT
  OPENED
  CLICKED
  COMPLETED
  EXPIRED
  CANCELLED
}

enum LandingPageTemplate {
  PROFESSIONAL
  MODERN
  CLASSIC
  MINIMAL
  BOLD
  CUSTOM
}

enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CaseStatus {
  INTAKE
  ACTIVE
  PENDING
  ON_HOLD
  SETTLED
  CLOSED
  ARCHIVED
}

enum CasePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum FeeArrangement {
  HOURLY
  FLAT_FEE
  CONTINGENCY
  RETAINER
  HYBRID
  PRO_BONO
}

enum DocumentCategory {
  CONTRACT
  COURT_FILING
  CORRESPONDENCE
  EVIDENCE
  INTAKE
  INVOICE
  ID_DOCUMENT
  MEDICAL_RECORD
  POLICE_REPORT
  ENGAGEMENT_LETTER
  OTHER
}

enum AccessLevel {
  PUBLIC
  CLIENT
  INTERNAL
  CONFIDENTIAL
}

enum SignatureStatus {
  PENDING
  SENT
  VIEWED
  SIGNED
  DECLINED
  VOIDED
}

enum IntakeStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  CONVERTED
}

enum MessageType {
  TEXT
  FILE
  SYSTEM
  AI_RESPONSE
}

enum AppointmentType {
  CONSULTATION
  MEETING
  COURT_DATE
  DEPOSITION
  MEDIATION
  PHONE_CALL
  VIDEO_CALL
  OTHER
}

enum LocationType {
  IN_PERSON
  VIDEO
  PHONE
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkflowTrigger {
  NEW_CLIENT
  NEW_CASE
  CASE_STATUS_CHANGE
  DOCUMENT_UPLOADED
  FORM_SUBMITTED
  DEADLINE_APPROACHING
  PAYMENT_RECEIVED
  APPOINTMENT_SCHEDULED
  MANUAL
  SCHEDULED
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
  WRITTEN_OFF
}

enum PaymentMethod {
  CARD
  ACH
  CHECK
  CASH
  WIRE
  OTHER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum TemplateType {
  EMAIL
  SMS
  DOCUMENT
  INTAKE_FORM
  INVOICE
  LETTER
}

enum IntegrationType {
  CLIO
  MYCASE
  PRACTICE_PANTHER
  QUICKBOOKS
  XERO
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR
  DOCUSIGN
  STRIPE
  TWILIO
  SENDGRID
}

enum AIJobType {
  DOCUMENT_ANALYSIS
  CASE_PREDICTION
  SENTIMENT_ANALYSIS
  INTAKE_PROCESSING
  MEETING_SUMMARY
  DOCUMENT_GENERATION
  CONFLICT_CHECK
  DEADLINE_CALCULATION
  LEAD_SCORING
  CHATBOT_RESPONSE
}

enum AIJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
